<!DOCTYPE html>
<html>
<head>
    <title>wsjf_grid</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext,app=null;Ext.define("CustomApp",{extend:"Rally.app.App",uses:["Ext.ux.exporter.Exporter"],componentCls:"app",launch:function(){this._boxcontainer=Ext.create("Ext.form.Panel",{title:"Grid Filters",layout:{type:"hbox"},width:"95%",bodyPadding:10}),this._releaseCombobox=this.add({xtype:"rallyreleasecombobox",stateful:!0,padding:5,stateId:this.getContext().getScopedStateId("release"),allowNoEntry:!0,noEntryValue:"/release/-1",clearText:"-- Ignore Release Filter --",allowClear:!0,emptyText:"Filter by release...",context:this.getContext(),defaultToCurrentTimebox:!1,defaultSelectionPosition:null,listeners:{ready:this._onReleaseAvailable,select:this._onReleaseChanged,scope:this}})},_onReleaseAvailable:function(combo){combo.getStore().getAt(0).set("formattedName","-- Ignore Release Filter --"),this._boxcontainer.add(this._releaseCombobox),this._addPICombobox()},_onReleaseChanged:function(){if(this._piCombobox&&(console.log("resetting filter"),0===this._piCombobox.getRecord().get("Ordinal"))){var grid=this.down("rallygrid"),store=grid.getStore(),filter=this._getReleaseFilter();store.clearFilter(filter.length>0),filter.length&&store.filter(this._getReleaseFilter())}},_addPICombobox:function(){var app=this;this._piCombobox=this.add({xtype:"rallyportfolioitemtypecombobox",padding:5,listeners:{ready:this._onPICombobox,select:this._onPICombobox,scope:this}}),this._boxcontainer.add(this._piCombobox),this._checkbox=this.add({xtype:"rallycheckboxfield",fieldLabel:"Show Values After the Decimal",labelWidth:200,padding:"5, 5, 5, 10",stateful:!0,stateId:this.getContext().getScopedStateId("mycheckbox"),stateEvents:["change"],value:!1,listeners:{change:this._onPICombobox,scope:this}}),this._myButton=this.add({xtype:"rallybutton",height:20,text:"Export to CSV",listeners:{scope:this,click:function(){var exporter=Ext.create("GridExporter",{});exporter.exportGrid(app._myGrid)}}}),this._boxcontainer.add(this._checkbox),this._boxcontainer.add(this._myButton),this.add(this._boxcontainer)},_onPICombobox:function(){if(this._piCombobox){var selectedType=this._piCombobox.getRecord();0===this._piCombobox.getRecord().get("Ordinal")?this._releaseCombobox.enable():this._releaseCombobox.disable(),Rally.data.ModelFactory.getModel({type:selectedType.get("TypePath"),success:function(model){if(void 0===this._myGrid)Ext.create("Rally.data.WsapiDataStore",{model:model,autoLoad:!0,filters:this._getReleaseFilter(),remoteSort:!1,listeners:{load:function(store,records,success){this._calculateScore(records),this._updateGrid(store)},update:function(store,rec,modified,opts){this._calculateScore([rec])},scope:this},fetch:["Name","FormattedID","Release","TimeCriticality","RROEValue","UserBusinessValue","WSJFScore","JobSize"]});else{this._myGrid.reconfigureWithModel(model);var store=this._myGrid.getStore();if(0===this._piCombobox.getRecord().get("Ordinal")){var filter=this._getReleaseFilter();store.clearFilter(filter.length>0),filter.length&&store.filter(this._getReleaseFilter())}var that=this;store.addListener("update",function(store,rec,modified,opts){that._calculateScore([rec])}),store.addListener("load",function(store,records,modified,opts){that._calculateScore(records),that._updateGrid(store)})}},scope:this})}},_calculateScore:function(records){var that=this;Ext.Array.each(records,function(feature){var jobSize=feature.data.JobSize,timeValue=feature.data.TimeCriticality,OERR=feature.data.RROEValue,userValue=feature.data.UserBusinessValue,oldScore=feature.data.WSJFScore,isChecked=!1;if(that._checkbox&&(isChecked=that._checkbox.getValue()),jobSize>0){var score;score=isChecked?Math.floor(100*((userValue+timeValue+OERR)/jobSize))/100:Math.floor((userValue+timeValue+OERR)/jobSize+.5),oldScore!==score&&feature.set("WSJFScore",score)}})},_createGrid:function(myStore){this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",title:"Feature Scoring Grid",showPagingToolbar:!0,pagingToolbarCfg:{pageSizes:[50,100,200,500,1e3]},height:"98%",width:"98%",store:myStore,enableBulkEdit:!0,enableRanking:!0,defaultSortToRank:!0,selType:"cellmodel",columnCfgs:[{text:"Portfolio ID",dataIndex:"FormattedID",flex:1,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},"TimeCriticality","RROEValue","UserBusinessValue","JobSize",{text:"WSJF Score",dataIndex:"WSJFScore",editor:null}],scope:this}),this.add(this._myGrid)},_updateGrid:function(myStore){void 0===this._myGrid?this._createGrid(myStore):this._myGrid.reconfigure(myStore)},_getReleaseFilter:function(){var combo=this.down("rallyreleasecombobox");return combo.getValue()?[combo.getQueryFromSelected()]:[]}});
                Ext.define("GridExporter",{dateFormat:"Y-m-d g:i",exportGrid:function(grid){if(Ext.isIE)this._ieToExcel(grid);else{var data=this._getCSV(grid);window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)}},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData){var text;return text=null===fieldData||void 0===fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData.match?fieldData:""},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="",that=this;return Ext.Array.each(cols,function(col,index){col.hidden!==!0&&(data+=that._getFieldTextAndEscape(col.text)+",")}),data+="\n",store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName];data+=that._getFieldTextAndEscape(text)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){col.hidden!==!0&&(console.log("header: ",col.text),sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}xlBook.worksheets("Sheet1").activate();var XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet),XlSheet.columns.autofit()}}});

            Rally.launchApp('CustomApp', {
                name:"wsjf_grid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
