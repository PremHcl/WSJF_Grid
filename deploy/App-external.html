<!DOCTYPE html>
<html>
<head>
    <title>wsjf_grid</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var context=this.getContext();this.releaseCombobox=this.add({xtype:"rallyreleasecombobox",stateful:!0,stateId:this.getContext().getScopedStateId("release"),allowNoEntry:!0,noEntryValue:"/release/-1",clearText:"-- Clear Filter --",allowClear:!0,emptyText:"Filter by release...",context:this.getContext(),defaultToCurrentTimebox:!1,defaultSelectionPosition:null,listeners:{ready:this._onReleaseAvailable,select:this._onReleaseChanged,scope:this}})},_onReleaseAvailable:function(combo){combo.getStore().getAt(0).set("formattedName","-- Clear Filter --"),console.log("Adding Release Combobox"),this._addPICombobox()},_onReleaseChanged:function(){if(this.piCombobox&&(console.log("resetting filter"),0===this.piCombobox.getRecord().get("Ordinal"))){var grid=this.down("rallygrid"),store=grid.getStore(),filter=this._getReleaseFilter();store.clearFilter(filter.length>0),filter.length&&store.filter(this._getReleaseFilter())}},_addPICombobox:function(){this.piCombobox=this.add({xtype:"rallyportfolioitemtypecombobox",listeners:{ready:this._onPICombobox,select:this._onPICombobox,scope:this}})},_onPICombobox:function(){if(this.piCombobox){var selectedType=this.piCombobox.getRecord();0===this.piCombobox.getRecord().get("Ordinal")?this.releaseCombobox.enable():this.releaseCombobox.disable(),Rally.data.ModelFactory.getModel({type:selectedType.get("TypePath"),success:function(model){if(void 0===this._myGrid)Ext.create("Rally.data.WsapiDataStore",{model:model,autoLoad:!0,filters:this._getReleaseFilter(),remoteSort:!1,listeners:{load:function(store,records,success){this._calculateScore(records),this._updateGrid(store)},update:function(store,rec,modified,opts){this._calculateScore([rec])},scope:this},fetch:["Name","FormattedID","Release","TimeCriticality","RROEValue","UserBusinessValue","WSJFScore","JobSize"]});else{this._myGrid.reconfigureWithModel(model);var store=this._myGrid.getStore();if(0===this.piCombobox.getRecord().get("Ordinal")){var filter=this._getReleaseFilter();store.clearFilter(filter.length>0),filter.length&&store.filter(this._getReleaseFilter())}var that=this;store.addListener("update",function(store,rec,modified,opts){that._calculateScore([rec])}),store.addListener("load",function(store,records,modified,opts){that._calculateScore(records),that._updateGrid(store)})}},scope:this})}},_calculateScore:function(records){Ext.Array.each(records,function(feature){var jobSize=feature.data.JobSize,timeValue=feature.data.TimeCriticality,OERR=feature.data.RROEValue,userValue=feature.data.UserBusinessValue,oldScore=feature.data.WSJFScore;if(jobSize>0){var score,defaultToIntegerScore=!0;score=defaultToIntegerScore?Math.floor((userValue+timeValue+OERR)/jobSize+.5):Math.floor(100*((userValue+timeValue+OERR)/jobSize))/100,oldScore!==score&&feature.set("WSJFScore",score)}})},_createGrid:function(myStore){this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygridboard",title:"Feature Scoring Grid",height:"98%",store:myStore,enableBulkEdit:!0,enableRanking:!0,defaultSortToRank:!0,selType:"cellmodel",columnCfgs:[{text:"Portfolio ID",dataIndex:"FormattedID",flex:1,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:2},"TimeCriticality","RROEValue","UserBusinessValue","JobSize",{text:"WSJF Score",dataIndex:"WSJFScore",editor:null}],scope:this}),this.add(this._myGrid)},_updateGrid:function(myStore){void 0===this._myGrid?this._createGrid(myStore):this._myGrid.reconfigure(myStore)},_getReleaseFilter:function(){var combo=this.down("rallyreleasecombobox");return combo.getValue()?[combo.getQueryFromSelected()]:[]}});

            Rally.launchApp('CustomApp', {
                name:"wsjf_grid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
