<!DOCTYPE html>
<html>
<head>
    <title>wsjf_grid</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext = window.Ext4 || window.Ext;
var app = null;
Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    uses: [
        'Ext.ux.exporter.Exporter'
    ],

    componentCls: 'app',
    //items:{ html:'<a href="https://help.rallydev.com/apps/2.0/doc/">App SDK 2.0 Docs</a>'},
    launch: function() {
        this._boxcontainer = Ext.create('Ext.form.Panel', {
            title: 'Grid Filters',
            layout: { type: 'hbox'},
            width: '95%',
            bodyPadding: 10
        });
        
        this._releaseCombobox = this.add({
            xtype: 'rallyreleasecombobox',
            stateful: true,
            padding: 5,
            stateId: this.getContext().getScopedStateId('release'),
            allowNoEntry: true,
            noEntryValue: '/release/-1',
            clearText: '-- Ignore Release Filter --',
            allowClear: true,
            emptyText: 'Filter by release...',
            context: this.getContext(),
            defaultToCurrentTimebox: false,
            defaultSelectionPosition: null,
            listeners: {
                ready: this._onReleaseAvailable,
                select: this._onReleaseChanged,
                scope: this
            }
        });
    }, //end launch
    
    _onReleaseAvailable: function(combo) {
        combo.getStore().getAt(0).set('formattedName', '-- Ignore Release Filter --');
        this._boxcontainer.add(this._releaseCombobox); //new
        this._addPICombobox();
    },
    
    _onReleaseChanged: function() {
        // if we don't yet have a PI combo box or if this is anything other than
        // the lowest level PI, bail
        if ( this._piCombobox ) {
            console.log("resetting filter");
            if (this._piCombobox.getRecord().get('Ordinal') === 0)
            {
                var grid = this.down('rallygrid'),
                store = grid.getStore(),
                filter = this._getReleaseFilter();
        
                store.clearFilter(filter.length > 0);
                if(filter.length) {
                  store.filter(this._getReleaseFilter());
                }
            }
        }
    },
    
    _addPICombobox: function() {
        var app = this;
        this._piCombobox = this.add({
            xtype: "rallyportfolioitemtypecombobox",
            padding: 5,
            listeners: {
                ready: this._onPICombobox,
                select: this._onPICombobox,
                scope: this
            }
        });
        this._boxcontainer.add(this._piCombobox); //new
        this._checkbox = this.add({
            xtype: 'rallycheckboxfield',
            fieldLabel: 'Show Values After the Decimal',
            labelWidth: 200,
            padding: '5, 5, 5, 10',
            stateful: true,
            stateId: this.getContext().getScopedStateId('mycheckbox'),
            stateEvents: ['change'],
            value: false,
            listeners: {
                change: this._onPICombobox,
                scope: this
            }
        });
         this._myButton = this.add({
            xtype : 'rallybutton',
            height : 20,
            text : 'Export to CSV',
            listeners : {
                scope :this,
                click : function() {
                    var exporter = Ext.create("GridExporter",{});
                    exporter.exportGrid(app._myGrid);
                }
            }
        });
        this._boxcontainer.add(this._checkbox);
        this._boxcontainer.add(this._myButton);
        this.add(this._boxcontainer);
    },

    _onPICombobox: function() {
        if( this._piCombobox ) {
            var selectedType = this._piCombobox.getRecord();
            if (this._piCombobox.getRecord().get('Ordinal') === 0) {
                // Only use the release filter if the PI is the lowest level
                // and then ensure it is enabled
                this._releaseCombobox.enable();
            } else { // disable the ReleaseComboBox if Feature not selected
               this._releaseCombobox.disable();
            }
        
            Rally.data.ModelFactory.getModel({
                type: selectedType.get('TypePath'),
                success: function(model){
                    if (this._myGrid === undefined) {
                        Ext.create("Rally.data.WsapiDataStore", {
                            model: model,
                            autoLoad: true,
                            filters: this._getReleaseFilter(),
                            remoteSort: false,
                            listeners: {
                                load: function(store, records, success) {
                                    this._calculateScore(records);
                                    this._updateGrid(store);
                                },
                                update: function(store, rec, modified, opts) {
                                    this._calculateScore([rec]);
                                },
                                scope: this
                            },
                            fetch: ["Name", "FormattedID", "Release", 
                                "TimeCriticality", "RROEValue", "UserBusinessValue",
                                "WSJFScore", "JobSize"]
                        });
                    }
                    else { // grid exists, reset the model to the correct PI type
                        this._myGrid.reconfigureWithModel(model);
                        
                        // clear and re-apply filter since reconfiguring model 
                        // doesn't do this
                        var store = this._myGrid.getStore();
                         if (this._piCombobox.getRecord().get('Ordinal') === 0) {
                            var filter = this._getReleaseFilter();
                    
                            store.clearFilter(filter.length > 0);
                            if(filter.length) {
                              store.filter(this._getReleaseFilter());
                            }
                        }
                       
                        // re-apply grid update listeners
                        var that = this;
                        store.addListener('update', function(store, rec, modified, opts) {
                            that._calculateScore([rec]);
                        });
                        store.addListener('load', function(store, records, modified, opts) {
                            that._calculateScore(records); that._updateGrid(store);
                        });
                    }
                },
                scope: this
            });
        }
    },
    
    _calculateScore: function(records) {
        var that = this;
        Ext.Array.each(records, function(feature) {
            //console.log("feature", feature.data);
            var jobSize = feature.data.JobSize;
            var timeValue = feature.data.TimeCriticality;
            var OERR = feature.data.RROEValue;
            var userValue = feature.data.UserBusinessValue;
            var oldScore = feature.data.WSJFScore;
            var isChecked = false;
            if( that._checkbox) {
                isChecked = that._checkbox.getValue();
            }
            
            if (jobSize > 0) { // jobSize is the denominator so make sure it's not 0
                var score;
    
                if( !isChecked ) {
                    score = Math.floor(((userValue + timeValue + OERR ) / jobSize) + 0.5);
                }
                else {
                    score = Math.floor(((userValue + timeValue + OERR ) / jobSize) * 100)/100;
                }

                if (oldScore !== score) { // only update if score changed
                    feature.set('WSJFScore', score); // set score value in db
                }
            }
        });
    },
    
    _createGrid: function(myStore) {
        this._myGrid = Ext.create("Rally.ui.grid.Grid", {
            xtype: "rallygrid",
            title: "Feature Scoring Grid",
            showPagingToolbar: true,
            pagingToolbarCfg: {
               pageSizes: [50, 100, 200, 500, 1000]
            },
            height: "98%",
            width: "98%",
            store: myStore,
            enableBulkEdit: true,
            enableRanking: true,
            defaultSortToRank: true,
            selType: "cellmodel",
            columnCfgs: [
                {
                    text: "Portfolio ID",
                    dataIndex: "FormattedID",
                    flex: 1,
                    xtype: "templatecolumn",
                    tpl: Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")
                }, 
                {
                    text: "Name",
                    dataIndex: "Name",
                    flex: 2
                }, 
                "TimeCriticality", "RROEValue", "UserBusinessValue", "JobSize", 
                {
                    text: "WSJF Score",
                    dataIndex: "WSJFScore",
                    editor: null
                }
            ],
            scope: this
        }), this.add(this._myGrid);
    },
    
    _updateGrid: function(myStore) {
        if (this._myGrid === undefined) {
            this._createGrid(myStore);
        }
        else {
            this._myGrid.reconfigure(myStore);
        }
    },
    
    _getReleaseFilter: function() {
        var combo = this.down('rallyreleasecombobox');
        return combo.getValue() ?
          [combo.getQueryFromSelected()] : [];
    }
});

                Ext.define("GridExporter", {
    dateFormat : 'Y-m-d g:i',

    exportGrid: function(grid) {
        if (Ext.isIE) {
            this._ieToExcel(grid);
        } else {
            var data = this._getCSV(grid);
            window.location = 'data:text/csv;charset=utf8,' + encodeURIComponent(data);
        }
    },

    _escapeForCSV: function(string) {
        if (string.match(/,/)) {
            if (!string.match(/"/)) {
                string = '"' + string + '"';
            } else {
                string = string.replace(/,/g, ''); // comma's and quotes-- sorry, just lose the commas
            }
        }
        return string;
    },

    _getFieldText: function(fieldData) {
        var text;

        if (fieldData === null || fieldData === undefined) {
            text = '';
            
        } else if (fieldData._refObjectName && !fieldData.getMonth) {
            text = fieldData._refObjectName;

        } else if (fieldData instanceof Date) {
            text = Ext.Date.format(fieldData, this.dateFormat);

        } else if (!fieldData.match) { // not a string or object we recognize...bank it out
            text = '';

        } else {
            text = fieldData;
        }

        return text;
    },

    _getFieldTextAndEscape: function(fieldData) {
        var string  = this._getFieldText(fieldData);
        return this._escapeForCSV(string);
    },

    _getCSV: function (grid) {
        var cols    = grid.columns;
        var store   = grid.store;
        var data    = '';

        var that = this;
        Ext.Array.each(cols, function(col, index) {
            if (col.hidden !== true) {
                data += that._getFieldTextAndEscape(col.text) + ',';
            }
        });
        data += "\n";

        store.each(function(record) {
            var entry       = record.getData();
            Ext.Array.each(cols, function(col, index) {
                if (col.hidden !== true) {
                    var fieldName   = col.dataIndex;
                    var text        = entry[fieldName];

                    data += that._getFieldTextAndEscape(text) + ',';
                }
            });
            data += "\n";
        });

        return data;
    },

    _ieGetGridData : function(grid, sheet) {
        var that            = this;
        var resourceItems   = grid.store.data.items;
        var cols            = grid.columns;

        Ext.Array.each(cols, function(col, colIndex) {
            if (col.hidden !== true) {
                console.log('header: ', col.text);
                sheet.cells(1,colIndex + 1).value = col.text;
            }
        });

        var rowIndex = 2;
        grid.store.each(function(record) {
            var entry   = record.getData();

            Ext.Array.each(cols, function(col, colIndex) {
                if (col.hidden !== true) {
                    var fieldName   = col.dataIndex;
                    var text        = entry[fieldName];
                    var value       = that._getFieldText(text);

                    sheet.cells(rowIndex, colIndex+1).value = value;
                }
            });
            rowIndex++;
        });
    },

    _ieToExcel: function (grid) {
        if (window.ActiveXObject){
            var  xlApp, xlBook;
            try {
                xlApp = new ActiveXObject("Excel.Application"); 
                xlBook = xlApp.Workbooks.Add();
            } catch (e) {
                Ext.Msg.alert('Error', 'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."');
                return;
            }

            xlBook.worksheets("Sheet1").activate();
            var XlSheet = xlBook.activeSheet;
            xlApp.visible = true; 

           this._ieGetGridData(grid, XlSheet);
           XlSheet.columns.autofit(); 
        }
    }
});

            Rally.launchApp('CustomApp', {
                name:"wsjf_grid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
